<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 é‡‘é¦¬å¥”é¨° æ–°æ˜¥åœ˜æ‹œ (å®‰å…¨éš±è—ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Noto Serif TC', serif;
            overflow: hidden; /* Keep body hidden, handle scroll in containers */
            background-color: #8B0000;
            touch-action: manipulation; /* Improve touch response */
        }
        
        /* --- å–œæ°£èƒŒæ™¯ --- */
        .bg-festive {
            background: radial-gradient(circle at center, #D9230F 0%, #8B0000 60%, #4a0404 100%);
            position: relative;
        }

        /* èƒŒæ™¯æµå‹•å…‰æ•ˆ */
        .bg-glow-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23FFD700' fill-opacity='0.05'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z'/%3E%3C/g%3E%3C/svg%3E");
            animation: shine 20s linear infinite;
        }

        @keyframes shine {
            0% { background-position: 0 0; }
            100% { background-position: 100px 100px; }
        }

        /* é‡‘ç²‰é£„è½å‹•ç•« */
        .gold-dust {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 4px #FFD700;
            animation: fall linear infinite;
            opacity: 0;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0); opacity: 1; }
            100% { transform: translateY(110vh) translateX(20px); opacity: 0; }
        }

        /* Danmu Animation */
        @keyframes flyLeft {
            0% { left: 100%; transform: translateX(0); }
            100% { left: 0%; transform: translateX(-100%); }
        }

        .danmu-item {
            position: absolute;
            white-space: nowrap;
            animation-name: flyLeft;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 10px rgba(255, 215, 0, 0.5);
            pointer-events: none;
            will-change: transform, left;
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        /* Lyrics Styling */
        .lyrics-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 40;
            max-width: 80%;
            pointer-events: none;
            text-align: left;
        }
        
        .lyric-line {
            font-size: 1.5rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.5s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .lyric-line.active {
            font-size: 2.5rem;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 2px 2px 4px rgba(0,0,0,0.8);
            transform: scale(1.05);
            transform-origin: left bottom;
        }

        @media (max-width: 768px) {
            .lyrics-container {
                bottom: 80px; /* Avoid mobile controls if any */
                left: 10px;
            }
            .lyric-line { font-size: 1rem; }
            .lyric-line.active { font-size: 1.5rem; }
        }
        
        /* Revised Mobile Scroll - Crucial for iframe/embedded views */
        .mobile-container-scroll {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Buttons */
        .btn-subtle {
            background-color: rgba(0, 0, 0, 0.3);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .btn-subtle:hover {
            background-color: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border-color: #FFD700;
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        .btn-lottery {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #8B0000;
            border: 2px solid #FFF;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            animation: pulse-gold 2s infinite;
        }
        .btn-lottery:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }
        .btn-ai {
            background: linear-gradient(135deg, #9C27B0 0%, #E040FB 100%);
            color: white;
            border: 1px solid #E1BEE7;
            box-shadow: 0 0 10px rgba(224, 64, 251, 0.5);
        }
        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(224, 64, 251, 0.8);
        }
        .btn-fortune {
            background: linear-gradient(135deg, #7B1FA2 0%, #BA68C8 100%);
            color: white;
            border: 1px solid #E1BEE7;
            box-shadow: 0 0 10px rgba(186, 104, 200, 0.5);
        }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* Lottery Modal */
        .lottery-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            padding: 1rem; /* RWD: Avoid edge touching on mobile */
        }
        .lottery-card {
            background: linear-gradient(to bottom, #8B0000, #400000);
            border: 4px solid #FFD700;
            border-radius: 20px;
            padding: 20px; /* RWD: Reduced padding on mobile */
            width: 100%;
            max-width: 800px;
            text-align: center;
            position: relative;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 640px) {
            .lottery-card { padding: 40px; }
        }
        
        /* Custom Scrollbar for results */
        .results-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .results-scroll::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        .results-scroll::-webkit-scrollbar-thumb {
            background: #FFD700;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-festive text-white h-screen w-screen overflow-hidden">
    <!-- Gold Dust Particles Container -->
    <div id="particles" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
    <div class="bg-glow-overlay pointer-events-none"></div>

    <div id="root" class="relative z-10 h-full"></div>

    <script>
        // Generate Gold Dust
        const particleContainer = document.getElementById('particles');
        for(let i=0; i<30; i++) {
            const p = document.createElement('div');
            p.className = 'gold-dust';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDuration = (Math.random() * 5 + 5) + 's';
            p.style.animationDelay = (Math.random() * 5) + 's';
            particleContainer.appendChild(p);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // ã€âš ï¸ å›ºå®šç¶²å€è¨­å®šã€‘
        // è«‹åœ¨æ­¤å¡«å…¥æ‚¨æƒ³è¦å›ºå®šçš„ç¶²å€ (ä¾‹å¦‚ https://your-app.web.app)
        // ç•™ç©ºå‰‡æœƒå˜—è©¦è‡ªå‹•æŠ“å–ç›®å‰çš„ç¶²å€
        const FIXED_URL = ""; 
        
        // ã€ğŸµ éŸ³æ¨‚èˆ‡æ­Œè©è¨­å®šã€‘
        const SONG_URL = "https://cdn1.suno.ai/4cabb5a9-5baa-418a-9e41-3ba04e6bd0ab.mp3";
        
        // æ­Œè©è³‡æ–™åº« (è«‹æ ¹æ“šæ­Œæ›²å¯¦éš›ç§’æ•¸èª¿æ•´ timeï¼Œå–®ä½ç‚ºã€Œç§’ã€)
        const LYRICS_DATA = [
            { time: 0, text: "ğŸµ (éŸ³æ¨‚å‰å¥) ğŸµ" },
            { time: 14, text: "å½°æ¿±çš„é¢¨" },
            { time: 16, text: "å¹æ‹‚è‘—å¯¬å»£è©¦è»Šå ´" },
            { time: 20, text: "æ¯ä¸€æ¢è·‘é“" },
            { time: 22, text: "éƒ½æ‰¿è¼‰æœªä¾†çš„å¤¢æƒ³" },
            { time: 27, text: "å¾æª¢æ¸¬æœå‹™" },
            { time: 29, text: "åˆ°å°ˆåˆ©ç ”ç™¼çš„èƒ½é‡" },
            { time: 33, text: "æˆ‘å€‘ç”¨æ•¸æ“š" },
            { time: 35, text: "å¯«ä¸‹æœ€ç²¾æº–çš„ç¯‡ç« " },
            { time: 40, text: "å…¬æ­£çš„çœ¼å…‰" },
            { time: 41, text: "ç§‘æŠ€çš„å°èˆª" },
            { time: 43, text: "æœå‹™çš„ç†±å¿±" },
            { time: 45, text: "å°ˆæ¥­åœ¨ç™¼å…‰" },
            { time: 46, text: "ç‚ºäº†è¡Œè»Šå®‰å…¨" },
            { time: 48, text: "æˆ‘å€‘çµ•ä¸é€€è®“" },
            { time: 54, text: "ARTC è»Šè¼›ä¸­å¿ƒ" },
            { time: 57, text: "å®ˆè­·å‰è¡Œçš„å…‰" },
            { time: 61, text: "æŠ€è¡“ç§»è½‰" },
            { time: 62, text: "è®“ç”¢æ¥­åœ¨ä¸–ç•Œç¿±ç¿”" },
            { time: 67, text: "é€™è£¡æ˜¯ å¤¢æƒ³çš„èµ·é»" },
            { time: 71, text: "å……æ»¿å¸Œæœ›" },
            { time: 74, text: "è®“å°ç£çš„è»Šè¼›" },
            { time: 77, text: "é§›å‘æ›´é çš„é æ–¹" },
            { time: 82, text: "ğŸµ (é–“å¥) ğŸµ" },
            { time: 87, text: "åš´æ ¼çš„ä¿å¯†" },
            { time: 90, text: "æ˜¯æˆ‘å€‘å°æ‚¨çš„æ‰¿è«¾" },
            { time: 94, text: "æœªå…¬é–‹çš„æ©Ÿå¯†" },
            { time: 96, text: "åƒçå¯¶ä¸€æ¨£å®ˆå€™" },
            { time: 100, text: "å¹•å¾Œçš„è‹±é›„" },
            { time: 102, text: "ä¸éœ€æŒè²çš„ç¨å¥" },
            { time: 107, text: "åªç‚ºäº†é‚£ä¸€åˆ»" },
            { time: 110, text: "å®Œç¾çš„å•Ÿå‹•" },
            { time: 114, text: "å…¬æ­£çš„çœ¼å…‰" },
            { time: 116, text: "ç§‘æŠ€çš„å°èˆª" },
            { time: 117, text: "æœå‹™çš„ç†±å¿±" },
            { time: 118, text: "å°ˆæ¥­åœ¨ç™¼å…‰" },
            { time: 120, text: "ç‚ºäº†è¡Œè»Šå®‰å…¨" },
            { time: 122, text: "æˆ‘å€‘çµ•ä¸é€€è®“" },
            { time: 128, text: "ARTC è»Šè¼›ä¸­å¿ƒ" },
            { time: 131, text: "å®ˆè­·å‰è¡Œçš„å…‰" },
            { time: 134, text: "æŠ€è¡“ç§»è½‰" },
            { time: 136, text: "è®“ç”¢æ¥­åœ¨ä¸–ç•Œç¿±ç¿”" },
            { time: 141, text: "é€™è£¡æ˜¯ å¤¢æƒ³çš„èµ·é»" },
            { time: 144, text: "å……æ»¿å¸Œæœ›" },
            { time: 147, text: "è®“å°ç£çš„è»Šè¼›" },
            { time: 150, text: "é§›å‘æ›´é çš„é æ–¹" },
            { time: 157, text: "å¾ç„¡åˆ°æœ‰ï¼Œå‰µæ–°çªç ´" },
            { time: 163, text: "æ™ºæ…§é§•é§›ï¼Œç¶ èƒ½ç”Ÿæ´»" },
            { time: 170, text: "æˆ‘å€‘æ˜¯æ¨æ‰‹ï¼Œä¹Ÿæ˜¯å …å¼·çš„å¾Œç›¾" },
            { time: 177, text: "èˆ‡æ‚¨æ”œæ‰‹ï¼Œå…±å‰µæ¦®è€€çš„å·”å³°" },
            { time: 183, text: "ARTC è»Šè¼›ä¸­å¿ƒ" },
            { time: 185, text: "å®ˆè­·å‰è¡Œçš„å…‰" },
            { time: 189, text: "æŠ€è¡“ç§»è½‰" },
            { time: 191, text: "è®“ç”¢æ¥­åœ¨ä¸–ç•Œç¿±ç¿”" },
            { time: 196, text: "é€™è£¡æ˜¯ å¤¢æƒ³çš„èµ·é»" },
            { time: 199, text: "å……æ»¿å¸Œæœ›" },
            { time: 202, text: "è®“å°ç£çš„è»Šè¼›" },
            { time: 205, text: "é§›å‘æ›´é çš„é æ–¹" },
            { time: 209, text: "ğŸµ (éŸ³æ¨‚å°¾å¥) ğŸµ" }
        ];



        // --- Icons ---
        const Smartphone = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>;
        const Send = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>;
        const Sparkles = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 17v4"/><path d="M15 19h4"/></svg>;
        const Trash2 = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const Play = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const Pause = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>;
        const Gift = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>;
        const X = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const MagicWand = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m19 2 2 2-2 2-2-2 2-2Z"/><path d="m5 7 2 2-2 2-2-2 2-2Z"/><path d="m15 4 2 2-2 2-2-2 2-2Z"/><path d="M14.5 11l-8 8a2.121 2.121 0 0 0 3 3l8-8"/></svg>;
        const Star = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
        const Search = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
        const Settings = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0-2.73-.73l.15-.08a2 2 0 0 1-2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const Check = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
        const Badge = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.78 4.78 4 4 0 0 1-6.74 0 4 4 0 0 1-4.78-4.78 4 4 0 0 1 0-6.74Z"/></svg>;
        const Lock = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const Unlock = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>;
        const Download = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const LinkIcon = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>;
        const Repeat = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>;
        const Shield = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;
        const Volume2 = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>;
        const VolumeX = ({ size = 24, className = "" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>;

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAxiiFc_Tu69k3Uz2rVX4veqZbXnN1XUFw",
            authDomain: "cny-2025-f534f.firebaseapp.com",
            projectId: "cny-2025-f534f",
            storageBucket: "cny-2025-f534f.firebasestorage.app",
            messagingSenderId: "51443648729",
            appId: "1:51443648729:web:3eb6096d1aa9da313716c8"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = "cny_group_greeting_2026_v4"; 
        const COLLECTION_NAME = "blessings";
        const CONFIG_DOC = "config"; // Configuration Document

        // Test Messages (å·²ç§»é™¤è«§éŸ³æ¢—)
        const TEST_MESSAGES = [
            { nickname: "ç³»çµ±æ¸¬è©¦", message: "2026 é‡‘é¦¬å¥”é¨°ï¼Œæ–°å¹´å¿«æ¨‚ï¼", color: "#FFD700" },
            { nickname: "å¥½é‹é€£é€£", message: "ç¥å¤§å®¶èº«é«”å¥åº·ï¼Œè¬äº‹å¦‚æ„ï¼", color: "#ADFF2F" },
            { nickname: "å°å¹«æ‰‹", message: "æ–°çš„ä¸€å¹´ï¼Œæ¥­ç¸¾é•·ç´…ï¼Œè²¡æºå»£é€²ï¼", color: "#00FFFF" },
            { nickname: "ç¦å§”æœƒ", message: "é–‹å·¥å¤§å‰ï¼Œå¤§çæ‹¿ä¸å®Œï¼", color: "#FF69B4" },
            { nickname: "å‰ç¥¥è©±", message: "å¹³å¹³å®‰å®‰ï¼Œé †é †åˆ©åˆ©ï¼", color: "#FFF" }
        ];

        const getBlessingsRef = () => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(COLLECTION_NAME);
        const getConfigRef = () => db.collection('artifacts').doc(APP_ID).collection('public').doc(CONFIG_DOC);

        // --- App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [viewMode, setViewMode] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                const modeParam = params.get('mode');
                
                // 1. å¼·åˆ¶æŒ‡å®šæ¨¡å¼
                if (modeParam === 'screen') return 'screen';
                if (modeParam === 'mobile') return 'mobile';
                
                // 2. è‡ªå‹•åµæ¸¬è£ç½®å¯¬åº¦ (PCé¡¯ç¤ºå¤§è¢å¹•ï¼Œæ‰‹æ©Ÿé¡¯ç¤ºè¼¸å…¥é )
                // å¯¬åº¦å¤§æ–¼ 768px (iPadç›´ç«‹å¯¬åº¦) è¦–ç‚ºå¤§è¢å¹•æ¨¡å¼
                return window.innerWidth > 768 ? 'screen' : 'mobile';
            });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    try { await auth.signInAnonymously(); } 
                    catch (error) { console.error("Auth error:", error); }
                };
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) { setUser(u); setLoading(false); } 
                    else { initAuth(); }
                });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="flex items-center justify-center h-screen text-2xl text-yellow-400 font-bold">è¼‰å…¥æ–°æ˜¥ç¥ç¦ç³»çµ±...</div>;

            return (
                <div className="h-full w-full relative">
                    {viewMode === 'mobile' ? (
                        <MobileView user={user} onSwitchToScreen={() => setViewMode('screen')} />
                    ) : (
                        <ScreenView user={user} onSwitchToMobile={() => setViewMode('mobile')} />
                    )}
                </div>
            );
        }

        // --- Mobile View ---
        function MobileView({ user, onSwitchToScreen }) {
            const [employeeId, setEmployeeId] = useState(''); // Employee ID State
            const [nickname, setNickname] = useState('');
            const [message, setMessage] = useState('');
            const [sending, setSending] = useState(false);
            const [showSuccess, setShowSuccess] = useState(false);
            const [secretCount, setSecretCount] = useState(0);
            const [isSubmissionOpen, setIsSubmissionOpen] = useState(true); // Global submission state
            const [errorMsg, setErrorMsg] = useState(''); // New state for UI error messages
            const [preventDuplicates, setPreventDuplicates] = useState(true); // Global config for duplicate prevention
            
            // Check local storage for previous submission
            const [hasSubmitted, setHasSubmitted] = useState(() => {
                return localStorage.getItem('cny_submitted') === 'true';
            });

            // é è¨­ç¥ç¦èªåˆ—è¡¨
            const PRESET_BLESSINGS = [
                "2026 é‡‘é¦¬å¥”é¨°ï¼Œæ–°å¹´å¿«æ¨‚ï¼",
                "ç¥å¤§å®¶èº«é«”å¥åº·ï¼Œè¬äº‹å¦‚æ„ï¼",               
                "é–‹å·¥å¤§å‰ï¼Œå¤§çæ‹¿ä¸å®Œï¼",
                "å¹³å¹³å®‰å®‰ï¼Œé †é †åˆ©åˆ©ï¼",
                "å¿ƒæƒ³äº‹æˆï¼Œæ­¥æ­¥é«˜å‡ï¼"
            ];

            // ğŸ›¡ï¸ Enhanced Security: Check Database for existing submission by this UID
            useEffect(() => {
                if (user?.uid) {
                    const checkSubmission = async () => {
                        try {
                            // Query Firestore to see if this user (UID) has already submitted
                            const snapshot = await getBlessingsRef()
                                .where('uid', '==', user.uid)
                                .limit(1)
                                .get();
                            
                            if (!snapshot.empty) {
                                // Found a previous submission!
                                setHasSubmitted(true);
                                localStorage.setItem('cny_submitted', 'true'); // Sync local storage
                                
                                // Restore their submitted data for feedback (Optional but nice)
                                const data = snapshot.docs[0].data();
                                if(data.nickname) setNickname(data.nickname);
                                if(data.employeeId) setEmployeeId(data.employeeId);
                                if(data.message) setMessage(data.message);
                            } else {
                                // Only reset if config allows (or if we really want to trust DB over local)
                                // But for now, we trust local first to avoid flicker, DB confirms it.
                            }
                        } catch (error) {
                            console.error("Error checking submission status:", error);
                        }
                    };
                    checkSubmission();
                }
            }, [user]);

            useEffect(() => {
                // Initialize from local storage only if not already set by DB check
                if (!hasSubmitted) {
                    const savedName = localStorage.getItem('cny_nickname');
                    if (savedName) setNickname(savedName);
                    const savedEmpId = localStorage.getItem('cny_empid');
                    if (savedEmpId) setEmployeeId(savedEmpId);
                }

                // Listen to Global Config
                const unsubscribe = getConfigRef().onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.submissionOpen !== undefined) {
                            setIsSubmissionOpen(data.submissionOpen);
                        }
                        if (data.preventDuplicates !== undefined) {
                            setPreventDuplicates(data.preventDuplicates);
                        }
                    }
                });
                return () => unsubscribe();
            }, [hasSubmitted]);

            // Determine if form is locked
            const isFormLocked = preventDuplicates && hasSubmitted;

            // æ–°å¢ï¼šå·¥è™Ÿè¼¸å…¥è™•ç† (åªå…è¨±æ•¸å­—ä¸”æœ€å¤š4ç¢¼)
            const handleEmployeeIdChange = (e) => {
                const value = e.target.value.replace(/\D/g, '').slice(0, 4);
                setEmployeeId(value);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setErrorMsg(''); // Reset error message
                
                if (!isSubmissionOpen) { 
                    setErrorMsg("ç›®å‰æš«åœæ¥æ”¶ç¥ç¦å›‰ï¼"); 
                    return; 
                }
                
                if (preventDuplicates && hasSubmitted) {
                    return; // Should be blocked by UI, but double check
                }
                
                // é©—è­‰å·¥è™Ÿæ ¼å¼
                if (employeeId.length !== 4) { 
                    setErrorMsg("å·¥è™Ÿå¿…é ˆæ˜¯ 4 ä½æ•¸å­—å–”ï¼"); 
                    return; 
                }

                if (!nickname.trim() || !message.trim() || !employeeId.trim() || !user) return; 
                
                if (message.length > 30) { 
                    setErrorMsg("ç¥ç¦èªè«‹æ§åˆ¶åœ¨30å­—ä»¥å…§å–”ï¼"); 
                    return; 
                }

                setSending(true);
                localStorage.setItem('cny_nickname', nickname); 
                localStorage.setItem('cny_empid', employeeId); 

                try {
                    // Check for duplicate employeeId (Global check across all users)
                    // We keep this check regardless of 'preventDuplicates' setting to prevent SAME employee ID reuse if desired, 
                    // BUT for "Allow Multiple Submissions" usually means allow everything.
                    // Let's relax this check if preventDuplicates is false, or keep it strict?
                    // User request: "prevent duplicate devices". Usually EmpID uniqueness is a separate business rule.
                    // Let's KEEP EmpID check strict for consistency unless user asked to remove it.
                    
                    const duplicateCheck = await getBlessingsRef()
                        .where('employeeId', '==', employeeId.trim())
                        .limit(1)
                        .get();

                    // Only block duplicate EmpID if strict mode is ON or simply always?
                    // The prompt implies we want to control the "Device Lock". 
                    // Let's assume duplicate EmpID is always bad in a lottery context.
                    if (!duplicateCheck.empty) {
                         // However, if I am the SAME user resubmitting (and strict mode is OFF), I shouldn't be blocked by my own previous doc.
                         // But for simplicity in this "New Year Greeting" context, usually EmpID is unique.
                         // If strict mode is OFF (Infinity mode), we likely allow spamming.
                         if (preventDuplicates) {
                             setErrorMsg("âš ï¸ é€™å€‹å·¥è™Ÿå·²ç¶“é€å‡ºéå›‰ï¼\næ¯äººé™é€ä¸€æ¬¡ç¥ç¦ã€‚");
                             setSending(false);
                             return;
                         }
                    }

                    const colors = ['#FFD700', '#FFF', '#FF69B4', '#00FFFF', '#ADFF2F'];
                    const randomColor = colors[Math.floor(Math.random() * colors.length)];
                    await getBlessingsRef().add({
                        employeeId: employeeId.trim(), 
                        nickname: nickname.trim(),
                        message: message.trim(),
                        color: randomColor,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        uid: user.uid
                    });
                    
                    // Set submitted state
                    localStorage.setItem('cny_submitted', 'true');
                    setHasSubmitted(true);

                    // If we are allowing duplicates (infinite mode), we probably want to clear the message for next input
                    if (!preventDuplicates) {
                        setMessage('');
                        // Don't lock UI
                    } 

                    setShowSuccess(true);
                    setTimeout(() => setShowSuccess(false), 2000);
                } catch (error) { 
                    console.error("Error sending:", error);
                    setErrorMsg("å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
                } 
                finally { setSending(false); }
            };
            
            // åŸæœ‰çš„é»æ“Š5æ¬¡éš±è—åˆ‡æ›ä¿ç•™ï¼Œä½†æ–°å¢äº†é¡¯çœ¼çš„æŒ‰éˆ•
            const handleIconClick = () => {
                const newCount = secretCount + 1;
                setSecretCount(newCount);
                if (newCount >= 5) { onSwitchToScreen(); setSecretCount(0); }
            };

            return (
                <div className="mobile-container-scroll">
                    <div className="min-h-full w-full flex flex-col items-center justify-center p-4 py-8">
                        <div className="w-full max-w-lg space-y-4 sm:space-y-6 pb-24"> 
                            <div className="text-center space-y-2 mt-4">
                                <div onClick={handleIconClick} className="inline-block p-2 rounded-full bg-yellow-500/20 border-2 border-yellow-500 mb-2 cursor-pointer select-none">
                                    <span className="text-3xl">ğŸ´</span>
                                </div>
                                <h1 className="text-3xl font-black text-yellow-400 tracking-wider drop-shadow-lg">æ–°æ˜¥åœ˜æ‹œ</h1>
                                <p className="text-red-200 text-sm">å¯«ä¸‹æ‚¨çš„ç¥ç¦ï¼Œå‚³éåˆ°å¤§è¢å¹•ï¼</p>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4 input-glass p-6 rounded-2xl shadow-2xl relative">
                                {!isSubmissionOpen && (
                                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center rounded-2xl">
                                        <div className="text-center p-4">
                                            <p className="text-4xl mb-2">â›”</p>
                                            <p className="text-xl font-bold text-yellow-400">ç›®å‰æš«åœæŠ•ç¨¿</p>
                                            <p className="text-sm text-white/80">è«‹ç¨å€™ä¸»æŒäººé–‹æ”¾...</p>
                                        </div>
                                    </div>
                                )}

                                {/* Employee ID Field */}
                                <div className="space-y-1">
                                    <label className="text-yellow-200 font-bold text-base flex items-center gap-2">
                                        <Badge size={16} /> å·¥è™Ÿ (æŠ½çç”¨)
                                    </label>
                                    <input
                                        type="tel" value={employeeId} onChange={handleEmployeeIdChange}
                                        placeholder="è«‹è¼¸å…¥å·¥è™Ÿ..." required disabled={!isSubmissionOpen || isFormLocked}
                                        className="w-full bg-black/30 border border-yellow-500/50 rounded-xl p-3 text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400 text-base disabled:opacity-50"
                                        maxLength="4"
                                        pattern="\d{4}"
                                        inputMode="numeric"
                                    />
                                </div>

                                <div className="space-y-1">
                                    <label className="text-yellow-200 font-bold text-base flex justify-between items-center">
                                        <span>æ‚¨çš„æš±ç¨±</span>
                                    </label>
                                    <input
                                        type="text" value={nickname} onChange={(e) => setNickname(e.target.value)}
                                        placeholder="è«‹è¼¸å…¥åå­—..." required disabled={!isSubmissionOpen || isFormLocked}
                                        className="w-full bg-black/30 border border-yellow-500/50 rounded-xl p-3 text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400 text-base disabled:opacity-50"
                                    />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-yellow-200 font-bold text-base flex justify-between items-center">
                                        <span>ç¥ç¦çš„è©±</span>
                                    </label>
                                    <textarea
                                        value={message} onChange={(e) => setMessage(e.target.value)}
                                        placeholder="é‡‘é¦¬å¥”é¨°ï¼Œæ¥­ç¸¾é•·ç´…ï¼" 
                                        rows="3" maxLength={30} required disabled={!isSubmissionOpen || isFormLocked}
                                        className="w-full bg-black/30 border border-yellow-500/50 rounded-xl p-3 text-white placeholder-gray-400 focus:outline-none focus:border-yellow-400 text-base resize-none disabled:opacity-50"
                                    />
                                    <div className={`text-right text-xs ${message.length >= 30 ? 'text-red-400 font-bold' : 'text-yellow-200/60'}`}>
                                        {message.length} / 30
                                    </div>
                                    {/* å¿«é€Ÿç¥ç¦é¸æ“‡ */}
                                    <div className="flex flex-wrap gap-2 pt-1">
                                        <span className="text-xs text-yellow-200/60 w-full">å¿«é€Ÿé¸æ“‡ç¥ç¦ï¼š</span>
                                        {PRESET_BLESSINGS.map((msg, idx) => (
                                            <button
                                                key={idx}
                                                type="button"
                                                onClick={() => setMessage(msg)}
                                                disabled={!isSubmissionOpen || isFormLocked}
                                                className="text-xs bg-yellow-500/20 hover:bg-yellow-500/40 border border-yellow-500/50 text-yellow-200 rounded-full px-3 py-1 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                {msg}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Error Message Display */}
                                {errorMsg && (
                                    <div className="bg-red-900/80 border border-red-500 text-white px-4 py-3 rounded-xl text-center text-sm font-bold animate-pulse whitespace-pre-line shadow-lg">
                                        {errorMsg}
                                    </div>
                                )}

                                <button type="submit" disabled={sending || !isSubmissionOpen || isFormLocked} className={`w-full py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transform active:scale-95 transition-all ${sending || !isSubmissionOpen || isFormLocked ? 'bg-gray-600 cursor-not-allowed' : 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-red-900'}`}>
                                    {isFormLocked ? "âœ… æ‚¨å·²å®Œæˆç¥ç¦" : (isSubmissionOpen ? (sending ? 'ç™¼é€ä¸­...' : <><Send size={20} />ç¢ºèªé€å‡º</>) : 'â›” ç›®å‰æš«åœæ¥æ”¶ç¥ç¦')}
                                </button>
                                
                                {!preventDuplicates && hasSubmitted && (
                                    <p className="text-center text-xs text-yellow-300/60 mt-2">
                                        (ç„¡é™æš¢è¨€æ¨¡å¼é–‹å•Ÿä¸­ï¼šæ‚¨å¯ä»¥å†æ¬¡é€å‡º)
                                    </p>
                                )}
                            </form>
                            {showSuccess && (
                                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-2 z-50 animate-bounce">
                                    <Sparkles className="text-yellow-300" /><span>ç™¼é€æˆåŠŸï¼</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Lottery Modal Component ---
        function LotteryModal({ isOpen, onClose }) {
            const [participants, setParticipants] = useState([]); 
            const [loadingData, setLoadingData] = useState(false);
            
            // Search States
            const [targetSentence, setTargetSentence] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [hasSearched, setHasSearched] = useState(false);

            useEffect(() => {
                if (isOpen) {
                    setLoadingData(true);
                    setSearchResults([]);
                    setHasSearched(false);
                    getBlessingsRef().get().then(snapshot => {
                        const allData = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.nickname) {
                                allData.push(data);
                            }
                        });
                        setParticipants(allData);
                        setLoadingData(false);
                    }).catch(err => {
                        console.error(err);
                        setLoadingData(false);
                    });
                }
            }, [isOpen]);

            const handleSearch = () => {
                if (!targetSentence.trim()) return;
                setIsSearching(true);
                setHasSearched(true); 
                
                const matches = participants.filter(p => 
                    p.message && p.message.includes(targetSentence)
                );

                // Deduplicate logic
                const uniqueMatches = [];
                const seen = new Set();
                matches.forEach(m => {
                    const key = m.employeeId || m.nickname; 
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueMatches.push(m);
                    }
                });

                setSearchResults(uniqueMatches);
                setIsSearching(false);
            };

            if (!isOpen) return null;

            return (
                <div className="lottery-modal-overlay">
                    <div className="lottery-card">
                        <button onClick={onClose} className="absolute top-4 right-4 text-white/50 hover:text-white z-50">
                            <X size={32} />
                        </button>
                        
                        <h2 className="text-3xl text-yellow-400 font-bold mb-6">ğŸ” é‡‘å¥æœå°‹æŠ½ç</h2>
                        
                        {loadingData ? (
                            <p className="text-xl">è®€å–åå–®ä¸­...</p>
                        ) : (
                            <div className="flex flex-col h-full overflow-hidden">
                                <div className="flex gap-2 mb-4 shrink-0">
                                    <input 
                                        type="text" 
                                        value={targetSentence}
                                        onChange={(e) => setTargetSentence(e.target.value)}
                                        placeholder="è¼¸å…¥é‡‘å¥é—œéµå­— (å¦‚: é¦¬ä¸Šæœ‰éŒ¢)"
                                        className="flex-1 bg-white/10 border border-yellow-500/50 rounded-xl px-4 py-2 text-white focus:outline-none focus:border-yellow-400"
                                    />
                                    <button 
                                        onClick={handleSearch}
                                        className="bg-yellow-500 hover:bg-yellow-400 text-red-900 font-bold px-4 py-2 rounded-xl flex items-center gap-2 whitespace-nowrap"
                                    >
                                        <Search size={20} /> <span className="hidden sm:inline">æœå°‹</span>
                                    </button>
                                </div>

                                <div className="flex-1 overflow-y-auto results-scroll bg-black/20 rounded-xl p-4 border border-white/10">
                                    {searchResults.length === 0 ? (
                                        <div className="h-full flex flex-col items-center justify-center text-white/40 min-h-[200px]">
                                            {isSearching ? "æœå°‹ä¸­..." : (
                                                hasSearched ? (
                                                    <div className="text-center">
                                                        <p className="text-4xl mb-2">ğŸ˜…</p>
                                                        <p className="text-lg">æ‰¾ä¸åˆ°åŒ…å«ã€Œ<span className="text-yellow-400">{targetSentence}</span>ã€çš„ç¥ç¦èª</p>
                                                        <p className="text-sm mt-2 opacity-70">æ›å€‹é—œéµå­—è©¦è©¦ï¼Ÿ</p>
                                                    </div>
                                                ) : "è«‹è¼¸å…¥é—œéµå­—æœå°‹ï¼Œæ‰¾å‡ºé»˜å¥‘å¤¥ä¼´ï¼"
                                            )}
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            <div className="text-left text-yellow-300 text-sm mb-2 font-bold border-b border-white/10 pb-2 flex justify-between items-center sticky top-0 bg-[#590e0e] z-10 p-2 rounded">
                                                <span>ğŸ‰ æ‰¾åˆ° {searchResults.length} ä½é»˜å¥‘å¹¸é‹å…’</span>
                                                <button onClick={() => setSearchResults([])} className="text-xs text-white/50 hover:text-white">æ¸…é™¤çµæœ</button>
                                            </div>
                                            {searchResults.map((item, idx) => (
                                                <div key={idx} className="bg-white/10 p-3 rounded-lg flex flex-col sm:flex-row sm:items-center justify-between hover:bg-white/20 transition-colors text-left gap-2">
                                                    <div className="flex-1">
                                                        <div className="flex items-baseline gap-2">
                                                            {/* Display Employee ID */}
                                                            {item.employeeId && (
                                                                <span className="text-sm font-mono bg-blue-900/80 text-blue-200 px-2 py-0.5 rounded border border-blue-500/30">
                                                                    {item.employeeId}
                                                                </span>
                                                            )}
                                                            <span className="font-bold text-yellow-400 text-lg">{item.nickname}</span>
                                                        </div>
                                                        <div className="text-white/80 text-sm mt-1">
                                                            {item.message.split(targetSentence).map((part, i, arr) => (
                                                                <React.Fragment key={i}>
                                                                    {part}
                                                                    {i < arr.length - 1 && <span className="text-red-400 font-bold bg-yellow-300/20 px-1 rounded">{targetSentence}</span>}
                                                                </React.Fragment>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    <div className="text-2xl self-end sm:self-center">ğŸ</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Screen View ---
        function ScreenView({ user, onSwitchToMobile }) {
            const [danmuList, setDanmuList] = useState([]);
            const [qrUrl, setQrUrl] = useState('');
            const [isEditingQr, setIsEditingQr] = useState(false); 
            const [isPlaying, setIsPlaying] = useState(false);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [showLottery, setShowLottery] = useState(false);
        const [isHostedOnGemini, setIsHostedOnGemini] = useState(false);
        const [isSubmissionOpen, setIsSubmissionOpen] = useState(true); // Control Submission
        const [preventDuplicates, setPreventDuplicates] = useState(true); // Global config for duplicate prevention
        const [currentLyric, setCurrentLyric] = useState("");
        const [isMusicPlaying, setIsMusicPlaying] = useState(false); // æ§åˆ¶éŸ³æ¨‚æ’­æ”¾
        
        // ğŸ”¥ Admin Mode States (å®‰å…¨éš±è—ç‰ˆï¼šé è¨­éš±è—)
        const [showAdmin, setShowAdmin] = useState(false); 
            const [adminClickCount, setAdminClickCount] = useState(0); // é»æ“Šè¨ˆæ•¸
            const adminTimerRef = useRef(null); // è¨ˆæ™‚å™¨ ref
            const audioRef = useRef(null); // Audio element ref

            const historyRef = useRef([]);
            const queueRef = useRef([]);
            const tracksRef = useRef(new Array(8).fill(0));

            useEffect(() => { 
                // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰è¨­å®šå›ºå®šç¶²å€
                if (FIXED_URL && FIXED_URL.trim() !== "") {
                    setQrUrl(FIXED_URL.trim());
                } else {
                    // å¦‚æœæ²’æœ‰å›ºå®šç¶²å€ï¼Œå‰‡åŸ·è¡ŒåŸæœ¬çš„è‡ªå‹•åµæ¸¬é‚è¼¯
                    try {
                        const urlObj = new URL(window.location.href);
                        if (urlObj.hostname.includes('google') || urlObj.protocol === 'file:') {
                            setIsHostedOnGemini(true);
                        }

                        const customLink = urlObj.searchParams.get('qr_link');
                        if (customLink) {
                            setQrUrl(decodeURIComponent(customLink));
                        } else {
                            urlObj.searchParams.delete('mode');
                            urlObj.searchParams.delete('qr_link');
                            setQrUrl(urlObj.toString());
                        }
                    } catch (e) {
                        setQrUrl(window.location.href);
                    }
                }

                // Initial fetch for submission state
                getConfigRef().get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.submissionOpen !== undefined) {
                            setIsSubmissionOpen(data.submissionOpen);
                        }
                        if (data.preventDuplicates !== undefined) {
                            setPreventDuplicates(data.preventDuplicates);
                        }
                    }
                });
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubscribe = getBlessingsRef().orderBy('createdAt', 'desc').limit(50)
                    .onSnapshot((snapshot) => {
                         snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                const data = change.doc.data();
                                if (data && data.message) {
                                    historyRef.current.push(data);
                                    queueRef.current.push(data);
                                }
                            }
                        });
                    });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                let interval;
                if (isPlaying && !showLottery) {
                    interval = setInterval(() => spawnLogic(), 800);
                }
                // (ç§»é™¤æ­¤è™•çš„æ’­æ”¾æ§åˆ¶ï¼Œæ”¹ç”± togglePlay è™•ç†)
                return () => clearInterval(interval);
            }, [isPlaying, showLottery]);

            // Handle Lyric Update
            const handleTimeUpdate = () => {
                if (!audioRef.current) return;
                const currentTime = audioRef.current.currentTime;
                
                // Find current lyric line
                // Reversing to find the last line that matches the current time
                const activeLine = [...LYRICS_DATA].reverse().find(line => currentTime >= line.time);
                
                if (activeLine) {
                    setCurrentLyric(activeLine.text);
                }
            };

            // ğŸ”¥ Admin Trigger Logic
            const handleTitleClick = () => {
                const newCount = adminClickCount + 1;
                setAdminClickCount(newCount);
                
                // Clear previous timer
                if (adminTimerRef.current) clearTimeout(adminTimerRef.current);

                // Set new timer to reset count if user stops clicking
                adminTimerRef.current = setTimeout(() => {
                    setAdminClickCount(0);
                }, 1000);

                // If 5 clicks reached
                if (newCount >= 5) {
                    setShowAdmin(!showAdmin); // Toggle visibility
                    setAdminClickCount(0);
                    clearTimeout(adminTimerRef.current);
                }
            };

            const toggleSubmission = () => {
                const newState = !isSubmissionOpen;
                setIsSubmissionOpen(newState);
                getConfigRef().set({ submissionOpen: newState }, { merge: true });
            };

            const toggleDuplicatePrevention = () => {
            const newState = !preventDuplicates;
            setPreventDuplicates(newState);
            getConfigRef().set({ preventDuplicates: newState }, { merge: true });
        };

        // âœ… ç¨ç«‹çš„éŸ³æ¨‚æ’­æ”¾æ§åˆ¶
        const toggleMusic = () => {
            const newIsMusicPlaying = !isMusicPlaying;
            setIsMusicPlaying(newIsMusicPlaying);
            
            if (newIsMusicPlaying) {
                if (audioRef.current) {
                    audioRef.current.play().catch(e => {
                        console.error("Audio play error:", e);
                        alert("ç„¡æ³•æ’­æ”¾éŸ³æ¨‚ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨å®‰å…¨æ€§é˜»æ“‹ã€‚è«‹å˜—è©¦æ‰‹å‹•é»æ“Šç•«é¢ä»»æ„è™•å¾Œå†è©¦ä¸€æ¬¡ã€‚");
                        setIsMusicPlaying(false);
                    });
                }
            } else {
                if (audioRef.current) {
                    audioRef.current.pause();
                }
            }
        };

        const spawnLogic = () => {
                let nextMsg = null;
                if (queueRef.current.length > 0) nextMsg = queueRef.current[0];
                else if (historyRef.current.length > 0) nextMsg = historyRef.current[Math.floor(Math.random() * historyRef.current.length)];
                else nextMsg = TEST_MESSAGES[Math.floor(Math.random() * TEST_MESSAGES.length)];

                if (nextMsg) {
                    if (spawnDanmu(nextMsg) && queueRef.current.length > 0 && queueRef.current[0] === nextMsg) {
                        queueRef.current.shift();
                    }
                }
            };

            const handleAnimationEnd = (id) => setDanmuList(prev => prev.filter(item => item.id !== id));

            const spawnDanmu = (data) => {
                const now = Date.now();
                const availableTracks = [];
                for (let i = 0; i < 8; i++) if (now - tracksRef.current[i] > 6500) availableTracks.push(i);
                if (availableTracks.length === 0) return false;

                const trackIndex = availableTracks[Math.floor(Math.random() * availableTracks.length)];
                tracksRef.current[trackIndex] = now;

                const baseSize = window.innerWidth < 768 ? 1.5 : 2.5;
                const randomScale = Math.random() * 1.5;

                const newDanmu = {
                    id: Date.now() + Math.random(),
                    ...data,
                    top: `${10 + (trackIndex * 10)}%`,
                    duration: `22s`,
                    fontSize: `${Math.floor(randomScale) + baseSize}rem`
                };
                setDanmuList(prev => [...prev, newDanmu]);
                return true;
            };

            const clearScreen = () => { setDanmuList([]); tracksRef.current = new Array(8).fill(0); };
            const clearAllData = async () => {
                if (!showDeleteConfirm) { setShowDeleteConfirm(true); setTimeout(() => setShowDeleteConfirm(false), 3000); return; }
                try {
                    const snapshot = await getBlessingsRef().get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    historyRef.current = []; queueRef.current = []; setDanmuList([]);
                } catch (e) { console.error(e); } 
                finally { setShowDeleteConfirm(false); }
            };

            // åŒ¯å‡º CSV åŠŸèƒ½
            const exportToCsv = async () => {
                try {
                    const snapshot = await getBlessingsRef().get();
                    if (snapshot.empty) {
                        alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼");
                        return;
                    }

                    let csv = "\uFEFFå·¥è™Ÿ,æš±ç¨±,ç¥ç¦èª,ç™¼é€æ™‚é–“\n";
                    
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString('zh-TW') : '';
                        const empId = d.employeeId ? `"${d.employeeId.replace(/"/g, '""')}"` : '""';
                        const nick = d.nickname ? `"${d.nickname.replace(/"/g, '""')}"` : '""';
                        const msg = d.message ? `"${d.message.replace(/"/g, '""')}"` : '""';
                        
                        csv += `${empId},${nick},${msg},"${date}"\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `CNY_Blessings_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (error) {
                    console.error("Export error", error);
                    alert("åŒ¯å‡ºå¤±æ•—");
                }
            };
            
            // Generate standard (L) and high density (Q) QR codes
            const qrBaseUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrUrl)}&color=000000&bgcolor=FFFFFF`;
            const qrImg1 = `${qrBaseUrl}&size=400x400&ecc=L`; 
            const qrImg2 = `${qrBaseUrl}&size=400x400&ecc=Q`;

            return (
                <div className="relative h-screen w-screen overflow-hidden flex flex-col items-center justify-center">
                    
                    {/* Audio Player (Hidden) with preload */}
                    <audio 
                        ref={audioRef} 
                        src={SONG_URL} 
                        onTimeUpdate={handleTimeUpdate}
                        loop 
                        preload="auto"
                    />

                    {/* Lyrics Display - Left Bottom Corner */}
                    <div className="lyrics-container">
                        {currentLyric && (
                            <div className="lyric-line active drop-shadow-lg">
                                {currentLyric}
                            </div>
                        )}
                    </div>

                    {/* Top Right Mobile Switch - Only show in Admin Mode */}
                    {showAdmin && (
                        <div className="fixed top-4 right-4 z-50 opacity-0 hover:opacity-100 transition-opacity">
                            <button onClick={onSwitchToMobile} className="bg-black/50 text-white p-2 rounded-full backdrop-blur"><Smartphone size={20} /></button>
                        </div>
                    )}

                    {/* H1 Title: Main Theme (Background Watermark when playing) */}
                    <h1 
                        onClick={handleTitleClick}
                        className={`fixed left-1/2 -translate-x-1/2 transition-all duration-1000 ease-in-out font-black tracking-widest select-none cursor-default whitespace-nowrap
                        ${!isPlaying 
                            ? 'top-[20%] -translate-y-1/2 text-4xl sm:text-6xl md:text-8xl lg:text-9xl text-transparent bg-clip-text bg-gradient-to-b from-yellow-200 to-yellow-600 drop-shadow-[0_10px_10px_rgba(0,0,0,0.8)] z-50' 
                            : 'top-1/2 -translate-y-1/2 text-[15vw] text-yellow-500/5 blur-[3px] z-0 scale-110' // Watermark style
                        }`}
                    >
                        2026 é‡‘é¦¬å¥”é¨°
                    </h1>

                    {/* H2 Title: Subtitle (Moves to Top when playing) */}
                    <div className={`fixed w-full text-center transition-all duration-1000 ease-in-out z-40
                        ${!isPlaying 
                            ? 'top-[35%] -translate-y-1/2' 
                            : 'top-0 pt-6 pb-12 bg-gradient-to-b from-black/80 via-black/40 to-transparent' // Top Header Background
                        }`}>
                        <h2 
                            onClick={handleTitleClick} // Also allow unlocking here if H1 is hard to reach
                            className={`font-bold tracking-[0.2em] transition-all duration-1000
                            ${!isPlaying 
                                ? 'text-xl sm:text-3xl md:text-5xl text-yellow-100 drop-shadow-md' 
                                : 'text-3xl sm:text-5xl text-yellow-400 drop-shadow-[0_0_10px_rgba(255,215,0,0.8)]'
                            }`}>
                            æ–°æ˜¥åœ˜æ‹œ ç¥ç¦ç‰†
                        </h2>
                    </div>

                    {/* QR Code Edit Modal - Only if Admin */}
                    {isEditingQr && showAdmin && (
                        <div className="absolute z-50 flex items-center justify-center inset-0 bg-black/60 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl p-6 shadow-2xl w-full max-w-md mx-4">
                                <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Settings size={24} /> è¨­å®š QR Code é€£çµ</h3>
                                <p className="text-red-600 text-sm mb-2 font-bold bg-red-100 p-2 rounded">è«‹è¼¸å…¥æ­£ç¢ºçš„ç¶²å€ (ä¾‹å¦‚å…§ç¶² IP æˆ–ç¶²åŸŸåç¨±)</p>
                                <input 
                                    type="text" 
                                    value={qrUrl} 
                                    onChange={(e) => setQrUrl(e.target.value)}
                                    className="w-full border border-gray-300 rounded-lg px-4 py-3 text-black mb-4 focus:ring-2 focus:ring-yellow-500 outline-none"
                                    placeholder="https://..."
                                />
                                <div className="flex justify-end gap-2">
                                    <button onClick={() => setIsEditingQr(false)} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors">
                                        <Check size={20} /> å®Œæˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Left QR Code Container */}
                    <div className={`absolute z-[60] flex flex-col items-center gap-2 bg-white/90 rounded-2xl shadow-[0_0_50px_rgba(255,215,0,0.6)] border-4 border-yellow-500 transition-all duration-1000 ease-in-out ${isPlaying ? "top-8 left-8 p-2 scale-75 origin-top-left" : "top-[60%] left-[20%] p-4 -translate-x-1/2 -translate-y-1/2 scale-100"}`}>
                        <img src={qrImg1} alt="QR Standard" className={`object-contain transition-all duration-1000 ${isPlaying ? "w-20 md:w-32 h-20 md:h-32" : "w-40 sm:w-56 h-40 sm:h-56"}`} />
                        <span className={`text-black text-xs font-bold mt-1 ${isPlaying ? 'hidden' : 'block'}`}>ä¸€èˆ¬ (é è·)</span>
                        <p className={`font-bold text-red-900 transition-all duration-1000 ${isPlaying ? "text-xs md:text-sm" : "text-lg sm:text-xl animate-pulse"}`}>
                            {isPlaying ? "æƒç¢¼é€ç¥ç¦" : "æƒç¢¼åŠ å…¥"}
                        </p>
                    </div>

                    {/* Right QR Code Container */}
                    <div className={`absolute z-[60] flex flex-col items-center gap-2 bg-white/90 rounded-2xl shadow-[0_0_50px_rgba(255,215,0,0.6)] border-4 border-yellow-500 transition-all duration-1000 ease-in-out ${isPlaying ? "top-8 right-8 p-2 scale-75 origin-top-right" : "top-[60%] right-[20%] p-4 translate-x-1/2 -translate-y-1/2 scale-100"}`}>
                        <img src={qrImg2} alt="QR High" className={`object-contain transition-all duration-1000 ${isPlaying ? "w-20 md:w-32 h-20 md:h-32" : "w-40 sm:w-56 h-40 sm:h-56"}`} />
                        <span className={`text-black text-xs font-bold mt-1 ${isPlaying ? 'hidden' : 'block'}`}>é«˜å®¹éŒ¯ (æŠ—åå…‰)</span>
                        <p className={`font-bold text-red-900 transition-all duration-1000 ${isPlaying ? "text-xs md:text-sm" : "text-lg sm:text-xl animate-pulse"}`}>
                            {isPlaying ? "æƒç¢¼é€ç¥ç¦" : "æƒç¢¼åŠ å…¥"}
                        </p>
                    </div>

                    {/* Gemini/File Protocol Warning (Center Bottom) - Only show if Admin */}
                    {isHostedOnGemini && !isPlaying && showAdmin && !FIXED_URL && (
                        <div className="absolute bottom-24 bg-black/80 text-yellow-300 text-xs p-3 rounded-full text-center backdrop-blur-sm z-30 animate-bounce">
                            âš ï¸ åµæ¸¬åˆ°é è¦½é€£çµã€‚è«‹æ‰‹å‹•é»æ“Šå³ä¸‹è§’ã€ŒQRè¨­å®šã€æˆ–åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ FIXED_URLã€‚
                        </div>
                    )}

                    <div className="absolute inset-0 overflow-hidden pointer-events-none z-20">
                        {danmuList.map(item => (
                            <div key={item.id} className="danmu-item font-bold text-white flex items-center gap-4"
                                style={{ top: item.top, animationDuration: item.duration, fontSize: item.fontSize, color: item.color, animationPlayState: (isPlaying && !showLottery) ? 'running' : 'paused' }}
                                onAnimationEnd={() => handleAnimationEnd(item.id)}>
                                <span className="bg-red-800/80 px-4 py-1 rounded-full text-[0.5em] border border-yellow-500/50 text-yellow-200">{item.nickname}</span>
                                <span className="drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">{item.message}</span>
                            </div>
                        ))}
                    </div>

                    {/* Admin Controls - Hidden by default */}
                    {showAdmin && (
                        <div className="absolute bottom-4 right-4 z-50 flex flex-wrap justify-end gap-2 sm:gap-4 max-w-full p-2 bg-black/40 rounded-2xl backdrop-blur-md border border-white/10 animate-fade-in-up">
                             {/* éš±è— QR è¨­å®šæŒ‰éˆ•
                             <button onClick={() => setIsEditingQr(!isEditingQr)} className="btn-subtle px-3 py-2 sm:px-4 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg font-bold" title="è¨­å®š QR Code é€£çµ">
                                <LinkIcon size={20} className="sm:w-6 sm:h-6" /> <span className="hidden sm:inline">QRè¨­å®š</span><span className="sm:hidden">QR</span>
                            </button>
                             */}
                             <button onClick={toggleSubmission} className={`btn-subtle px-3 py-2 sm:px-4 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg font-bold ${isSubmissionOpen ? 'text-green-300 border-green-500/30' : 'text-red-300 border-red-500/30 bg-red-900/30'}`} title={isSubmissionOpen ? "ç›®å‰é–‹æ”¾ä¸­ï¼Œé»æ“Šæš«åœ" : "ç›®å‰æš«åœä¸­ï¼Œé»æ“Šé–‹æ”¾"}>
                                {isSubmissionOpen ? <Unlock size={20} className="sm:w-6 sm:h-6" /> : <Lock size={20} className="sm:w-6 sm:h-6" />} <span className="hidden sm:inline">{isSubmissionOpen ? "é–‹æ”¾æŠ•ç¨¿" : "æš«åœæŠ•ç¨¿"}</span><span className="sm:hidden">{isSubmissionOpen ? "é–‹" : "åœ"}</span>
                            </button>
                            {/* æ–°å¢ï¼šé˜²é‡è¤‡é–‹é—œ */}
                            <button onClick={toggleDuplicatePrevention} className={`btn-subtle px-3 py-2 sm:px-4 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg font-bold ${preventDuplicates ? 'text-blue-300 border-blue-500/30' : 'text-gray-400 border-gray-500/30'}`} title={preventDuplicates ? "é˜²é‡è¤‡é–‹å•Ÿä¸­ (ä¸€äººä¸€ç¥¨)" : "é˜²é‡è¤‡å·²é—œé–‰ (ç„¡é™æš¢è¨€)"}>
                                {preventDuplicates ? <Shield size={20} className="sm:w-6 sm:h-6" /> : <Repeat size={20} className="sm:w-6 sm:h-6" />} <span className="hidden sm:inline">{preventDuplicates ? "ä¸€äººä¸€ç¥¨" : "ç„¡é™æš¢è¨€"}</span><span className="sm:hidden">{preventDuplicates ? "é™" : "æš¢"}</span>
                            </button>
                             {/* éš±è—æŠ½çæŒ‰éˆ•
                         <button onClick={() => setShowLottery(true)} className="btn-subtle btn-lottery px-3 py-2 sm:px-4 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg font-bold" title="å¹¸é‹æŠ½ç">
                            <Gift size={20} className="sm:w-6 sm:h-6" /> <span className="hidden sm:inline">æŠ½ç</span><span className="sm:hidden">æŠ½</span>
                        </button>
                        */}
                         <button onClick={toggleMusic} className="btn-subtle px-3 py-2 sm:px-6 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg font-bold min-w-[100px] sm:min-w-[160px] justify-center" title="éŸ³æ¨‚é–‹é—œ">
                            {isMusicPlaying ? <Volume2 size={20} className="sm:w-6 sm:h-6" /> : <VolumeX size={20} className="sm:w-6 sm:h-6" />} {isMusicPlaying ? "éŸ³æ¨‚é–‹" : "éŸ³æ¨‚é—œ"}
                        </button>
                         <button onClick={() => setIsPlaying(!isPlaying)} className="btn-subtle px-3 py-2 sm:px-6 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg font-bold min-w-[100px] sm:min-w-[160px] justify-center" title="å½ˆå¹•æ’­æ”¾/æš«åœ">
                            {isPlaying ? <Pause size={20} fill="currentColor" className="sm:w-6 sm:h-6" /> : <Play size={20} fill="currentColor" className="sm:w-6 sm:h-6" />} {isPlaying ? "åœå½ˆå¹•" : "æ’­å½ˆå¹•"}
                        </button>
                         <button onClick={clearScreen} className="btn-subtle px-3 py-2 sm:px-4 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg" title="æ¸…å±">
                                <Sparkles size={16} className="sm:w-5 sm:h-5" /> <span className="hidden sm:inline">æ¸…å±</span><span className="sm:hidden">æ¸…</span>
                            </button>
                            <button onClick={exportToCsv} className="btn-subtle px-3 py-2 sm:px-4 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg font-bold" title="åŒ¯å‡º CSV">
                                <Download size={20} className="sm:w-6 sm:h-6" /> <span className="hidden sm:inline">åŒ¯å‡º</span><span className="sm:hidden">åŒ¯</span>
                            </button>
                            <button onClick={clearAllData} className={`btn-subtle px-3 py-2 sm:px-4 sm:py-3 rounded-full backdrop-blur-sm flex items-center gap-2 text-sm sm:text-lg font-bold ${showDeleteConfirm ? 'bg-red-600/90 text-white border-red-500' : 'btn-subtle-danger'}`} title="åˆªé™¤è³‡æ–™">
                                <Trash2 size={16} className="sm:w-5 sm:h-5" /> {showDeleteConfirm ? "ç¢ºå®šï¼Ÿ" : <><span className="hidden sm:inline">åˆªé™¤</span><span className="sm:hidden">åˆª</span></>}
                            </button>
                        </div>
                    )}

                    <LotteryModal isOpen={showLottery} onClose={() => setShowLottery(false)} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>